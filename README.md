# GenTS â€” Travel Story Generator

Telegram-Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€Ğ° Ñ„Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ğ¹, Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ñ… Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº Ğ¸Ğ· Ğ¿ÑƒÑ‚ĞµÑˆĞµÑÑ‚Ğ²Ğ¸Ğ¹ Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğ°Ğ¼ Ğ¸ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸ÑĞ¼.

## Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸

- ğŸ“¸ ĞŸÑ€Ğ¸Ñ‘Ğ¼ Ñ„Ğ¾Ñ‚Ğ¾ Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸ĞµĞ¼ EXIF (Ğ´Ğ°Ñ‚Ğ°, GPS)
- ğŸ¤ ĞŸÑ€Ğ¸Ñ‘Ğ¼ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
- âœï¸ ĞŸÑ€Ğ¸Ñ‘Ğ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²
- ğŸ“ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹ (Ñ€Ğ°Ğ´Ğ¸ÑƒÑ 200Ğ¼)
- ğŸŒ ĞĞ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· Nominatim Ğ¸ Wikipedia
- ğŸ‘¥ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ¾Ğ²
- ğŸ” Whitelist-Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹

## Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸

- **Runtime:** Next.js 14 (App Router) Ğ½Ğ° Vercel
- **Telegram Bot:** grammy (webhook-Ñ€ĞµĞ¶Ğ¸Ğ¼)
- **Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:** Supabase (PostgreSQL)
- **Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²:** Supabase Storage
- **Ğ“ĞµĞ¾ĞºĞ¾Ğ´Ğ¸Ğ½Ğ³:** Nominatim (OpenStreetMap)
- **EXIF:** exifr
- **Thumbnails:** sharp

## Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚

### 1. ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°

```bash
git clone https://github.com/IvanTsarou/GenTS.git
cd GenTS
npm install
```

### 2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ `.env.example` Ğ² `.env.local` Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ:

```bash
cp .env.example .env.local
```

```env
# Telegram Bot (Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñƒ @BotFather)
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_WEBHOOK_SECRET=your_random_secret

# Supabase (Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°)
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Ğ“ĞµĞ¾ĞºĞ¾Ğ´Ğ¸Ğ½Ğ³
NOMINATIM_USER_AGENT=gents-travel-bot

# ĞĞ´Ğ¼Ğ¸Ğ½
ADMIN_TOKEN=your_admin_token

# URL Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ğ¿Ğ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ğ½Ğ° Vercel)
APP_URL=https://your-app.vercel.app
```

### 3. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Supabase

1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ½Ğ° [supabase.com](https://supabase.com)
2. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ SQL Editor Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ· `supabase/migrations/001_initial_schema.sql`
3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Storage bucket Ñ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼ `media` (Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹)

### 4. Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°

Ğ”Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ½ÑƒĞ¶ĞµĞ½ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ URL Ğ´Ğ»Ñ webhook. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ngrok:

```bash
# Ğ¢ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ» 1: Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
npm run dev

# Ğ¢ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ» 2: ngrok Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ
ngrok http 3000
```

Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ webhook Ğ½Ğ° ngrok URL:

```bash
APP_URL=https://xxx.ngrok.io npm run setup-webhook
```

### 5. Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Vercel

1. ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğº [Vercel](https://vercel.com)
2. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
3. ĞŸĞ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ webhook:

```bash
APP_URL=https://your-app.vercel.app npm run setup-webhook
```

## ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±Ğ¾Ñ‚Ğ°

| ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------|
| `/start` | ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ |
| `/status` | Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¿Ğ¾ĞµĞ·Ğ´ĞºĞ¸ |
| `/locations` | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹ |
| `/tripnew [Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ]` | Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ĞµĞ·Ğ´ĞºÑƒ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ admin) |
| `/triplist` | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ĞµĞ·Ğ´Ğ¾Ğº |
| `/generate` | Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ story |
| `/help` | Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ° |

## API Endpoints

| ĞœĞµÑ‚Ğ¾Ğ´ | ĞŸÑƒÑ‚ÑŒ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|-------|------|----------|
| POST | `/api/webhook/telegram` | Webhook Ğ´Ğ»Ñ Telegram |
| GET | `/api/trip/:id/structured` | Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ĞµĞ·Ğ´ĞºĞ¸ |
| GET | `/api/trip/:id/locations` | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹ |
| POST | `/api/trip/:id/generate` | Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ story |
| GET | `/api/trip/:id/story` | ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ story |
| GET | `/api/admin/users` | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ |
| POST | `/api/admin/users` | Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ |
| DELETE | `/api/admin/users/:id` | Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ |

## Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°:

```bash
curl -X POST https://your-app.vercel.app/api/admin/users \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"telegram_id": 123456789, "name": "Admin", "is_verified": true, "is_admin": true}'
```

Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:

```bash
curl -X PATCH https://your-app.vercel.app/api/admin/users/USER_UUID \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"is_verified": true}'
```

## Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹

- 3 Ñ„Ğ¾Ñ‚Ğ¾ Ğ½Ğ° Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
- 3 Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ° Ğ½Ğ° Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚ĞµĞºÑÑ‚ + Ğ°ÑƒĞ´Ğ¸Ğ¾ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ½Ğ¾)
- Ğ’Ğ¸Ğ´ĞµĞ¾ Ğ´Ğ¾ 20 MB Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ ÑÑ€Ğ°Ğ·Ñƒ
- Ğ’Ğ¸Ğ´ĞµĞ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 20 MB Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ

## Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²

Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾ (>20 MB) ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ ĞºĞ°Ğº ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° Telegram Ğ¸ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾ĞµĞ·Ğ´ĞºĞ¸:

```bash
# ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‰Ğ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
node scripts/download-pending-media.js --list

# Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
node scripts/download-pending-media.js

# Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ² Supabase Storage
node scripts/download-pending-media.js --upload

# Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾ĞµĞ·Ğ´ĞºĞ¸
node scripts/download-pending-media.js --trip-id <uuid> --upload
```

Ğ¤Ğ°Ğ¹Ğ»Ñ‹ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ğ² Ğ¿Ğ°Ğ¿ĞºÑƒ `downloads/`.

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
GenTS/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ webhook/telegram/     # Telegram webhook
â”‚   â”‚   â”œâ”€â”€ trip/[id]/            # Trip API
â”‚   â”‚   â””â”€â”€ admin/users/          # Admin API
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ bot/                      # Telegram bot logic
â”‚   â”‚   â”œâ”€â”€ commands.ts
â”‚   â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â””â”€â”€ middleware/
â”‚   â”œâ”€â”€ supabase.ts               # Database client
â”‚   â”œâ”€â”€ exif.ts                   # EXIF extraction
â”‚   â”œâ”€â”€ thumbnails.ts             # Image processing
â”‚   â”œâ”€â”€ geocoding.ts              # Nominatim API
â”‚   â”œâ”€â”€ wikipedia.ts              # Wikipedia API
â”‚   â”œâ”€â”€ clustering.ts             # Location clustering
â”‚   â”œâ”€â”€ storage.ts                # Supabase Storage
â”‚   â””â”€â”€ logger.ts                 # Bot logging
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/               # SQL migrations
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ setup-webhook.js          # Webhook setup script
â”‚   â””â”€â”€ download-pending-media.js # Download large files
â””â”€â”€ vercel.json                   # Vercel config
```

## Ğ›Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ñ

MIT
